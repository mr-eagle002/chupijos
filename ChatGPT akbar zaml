#include <iostream>
#include <vector>
#include <map>
#include <fstream>
#include <sstream>
#include <regex>
using namespace std;

/* ===================== UTIL ===================== */
vector<string> split(const string& s, char d) {
    vector<string> v;
    string t;
    stringstream ss(s);
    while (getline(ss, t, d)) v.push_back(t);
    return v;
}

bool matriculeValide(const string& m) {
    regex pattern("^[A-Z]{2}[0-9]{4}$");
    return regex_match(m, pattern);
}

/* ===================== PERSONNE ===================== */
class Personne {
protected:
    string nom, matricule, salle;
public:
    Personne(string n, string m, string s) : nom(n), matricule(m), salle(s) {}
    virtual ~Personne() {}
    string getNom() const { return nom; }
    string getMatricule() const { return matricule; }
    string getSalle() const { return salle; }
    virtual string getRole() const = 0;
    virtual void accueil() const = 0;
};

/* ===================== ETUDIANT ===================== */
class Etudiant : public Personne {
    map<string, vector<float>> notes;
public:
    Etudiant(string n, string m, string s) : Personne(n, m, s) {}
    string getRole() const override { return "ST"; }

    void ajouterNote(string mat, float note) {
        if (note >= 0 && note <= 20)
            notes[mat].push_back(note);
    }

    map<string, vector<float>>& getNotes() { return notes; }

    float moyenneGlobale() const {
        float s = 0; int c = 0;
        for (auto& p : notes)
            for (float n : p.second) { s += n; c++; }
        return c ? s / c : 0;
    }

    void accueil() const override {
        cout << "\n===== STUDENT HOME =====\n";
        cout << "Name  : " << nom << "\n";
        cout << "Class : " << salle << "\n\n";
        for (auto& p : notes) {
            cout << p.first << " : ";
            for (float n : p.second) cout << n << " ";
            cout << "\n";
        }
        cout << "Global average : " << moyenneGlobale() << "\n";
    }
};

/* ===================== PROFESSEUR ===================== */
class Professeur : public Personne {
    vector<string> matieres;
public:
    Professeur(string n, string m, string s) : Personne(n, m, s) {}
    string getRole() const override { return "TE"; }

    void ajouterMatiere(string m) { matieres.push_back(m); }
    const vector<string>& getMatieres() const { return matieres; }

    void accueil() const override {
        cout << "\n===== PROFESSOR HOME =====\n";
        cout << "Name     : " << nom << "\n";
        cout << "Office   : " << salle << "\n";
        cout << "Subjects : ";
        for (auto& m : matieres) cout << m << " ";
        cout << "\n";
    }
};

/* ===================== ADMIN ===================== */
class Admin : public Personne {
public:
    Admin(string n, string m) : Personne(n, m, "ADMIN") {}
    string getRole() const override { return "AD"; }
    void accueil() const override {
        cout << "\n===== ADMIN HOME =====\n";
        cout << "Administrator : " << nom << "\n";
    }
};

/* ===================== ETABLISSEMENT ===================== */
class Etablissement {
    map<string, Personne*> users;
public:
    ~Etablissement() {
        for (auto& p : users) delete p.second;
    }

    Personne* getUser(const string& m) {
        return users.count(m) ? users[m] : nullptr;
    }

    void chargerCSV(const string& file) {
        ifstream f(file);
        string line; getline(f, line);
        while (getline(f, line)) {
            auto c = split(line, ',');
            if (c.size() < 5) continue;

            string mat = c[0], nom = c[1], role = c[2];
            string mats = c[3], salle = c[4];

            if (role == "ST")
                users[mat] = new Etudiant(nom, mat, salle);
            else if (role == "TE") {
                Professeur* p = new Professeur(nom, mat, salle);
                for (auto& m : split(mats, ';')) p->ajouterMatiere(m);
                users[mat] = p;
            }
            else if (role == "AD")
                users[mat] = new Admin(nom, mat);
        }
    }

    vector<Etudiant*> etudiantsParMatiere(const string& mat) {
        vector<Etudiant*> v;
        for (auto& p : users) {
            Etudiant* e = dynamic_cast<Etudiant*>(p.second);
            if (e && e->getNotes().count(mat)) v.push_back(e);
        }
        return v;
    }

    void exporterReleve(Etudiant* e) {
        string file = e->getMatricule() + "_releve.txt";
        ofstream f(file);
        f << "Student: " << e->getNom() << "\n";
        f << "Class: " << e->getSalle() << "\n\n";
        for (auto& p : e->getNotes()) {
            f << p.first << " : ";
            for (float n : p.second) f << n << " ";
            f << "\n";
        }
        f << "\nGlobal average: " << e->moyenneGlobale();
        f.close();
        cout << "✔ Releve exported to " << file << "\n";
    }

    void ajouterUser() {
        string m,n,r,s;
        cout << "Matricule: "; getline(cin,m);
        if (!matriculeValide(m)) return;
        cout << "Nom: "; getline(cin,n);
        cout << "Role (ST/TE/AD): "; getline(cin,r);
        cout << "Salle: "; getline(cin,s);

        if (users.count(m)) return;
        if (r=="ST") users[m]=new Etudiant(n,m,s);
        else if (r=="TE") users[m]=new Professeur(n,m,s);
        else if (r=="AD") users[m]=new Admin(n,m);
    }

    void supprimerUser() {
        string m; cout<<"Matricule: "; getline(cin,m);
        if (!users.count(m)) return;
        delete users[m];
        users.erase(m);
        cout<<"Deleted.\n";
    }
};

/* ===================== MAIN ===================== */
int main() {
    Etablissement e;
    e.chargerCSV("school_data.csv");

    while (true) {
        string m;
        cout << "\nLOGIN (AA0123) or Q: ";
        getline(cin,m);
        if (m=="Q") break;

        if (!matriculeValide(m)) {
            cout << "❌ Invalid matricule format.\n";
            continue;
        }

        Personne* u = e.getUser(m);
        if (!u) {
            cout << "❌ Matricule not found.\n";
            continue;
        }

        u->accueil();

        if (u->getRole()=="TE") {
            Professeur* p = dynamic_cast<Professeur*>(u);
            cout<<"\n1.Add grade  2.Export student  3.Logout\nChoice: ";
            string c; getline(cin,c);

            if (c=="1") {
                string sm, mat; float n;
                cout<<"Student matricule: "; getline(cin,sm);
                cout<<"Subject: "; getline(cin,mat);
                cout<<"Grade: "; cin>>n; cin.ignore();
                Etudiant* et = dynamic_cast<Etudiant*>(e.getUser(sm));
                if (et) et->ajouterNote(mat,n);
            }
            if (c=="2") {
                string sm; cout<<"Student matricule: ";
                getline(cin,sm);
                Etudiant* et = dynamic_cast<Etudiant*>(e.getUser(sm));
                if (et) e.exporterReleve(et);
            }
        }

        if (u->getRole()=="AD") {
            cout<<"\n1.Add user  2.Delete user  3.Logout\nChoice: ";
            string c; getline(cin,c);
            if (c=="1") e.ajouterUser();
            if (c=="2") e.supprimerUser();
        }
    }

    cout<<"\nProgram ended.\n";
    return 0;
}
